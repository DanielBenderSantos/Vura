<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>✨ Mapa Natal ✨</title>

<style>
body {
  background: #0f172a;
  color: #e5e7eb;
  font-family: Arial, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.box {
  background: #020617;
  padding: 20px;
  border-radius: 12px;
  width: 420px;
  box-shadow: 0 0 25px rgba(168,85,247,.4);
}

h2 {
  text-align: center;
  color: #a855f7;
}

label {
  display: block;
  margin-top: 10px;
}

input, select {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  border-radius: 6px;
  border: none;
}

button {
  width: 100%;
  margin-top: 15px;
  padding: 10px;
  background: #a855f7;
  border: none;
  border-radius: 6px;
  color: white;
  font-size: 16px;
  cursor: pointer;
}

button:hover {
  background: #9333ea;
}

svg {
  margin-top: 20px;
  width: 100%;
}
</style>
</head>

<body>
<div class="box">
  <h2>✨ Mapa Natal ✨</h2>

  <label>Nome</label>
  <input id="nome" value="Visitante">

  <label>Data de nascimento</label>
  <input type="date" id="data">

  <label>Hora</label>
  <input type="time" id="hora">

  <label>Cidade</label>
  <input id="cidade" value="São Paulo">

  <label>Latitude</label>
  <input id="lat" value="-23.5505">

  <label>Longitude</label>
  <input id="lng" value="-46.6333">

  <label>Sistema de Casas</label>
  <select id="casas">
    <option value="placidus">Placidus</option>
    <option value="whole_sign">Signos Inteiros</option>
    <option value="koch">Koch</option>
  </select>

  <label>Pontos extras</label>
  <select id="extras" multiple>
    <option value="lilith">Lilith</option>
    <option value="chiron">Chiron</option>
  </select>

  <button onclick="gerarMapa()">Gerar Mapa</button>

  <svg id="mapaNatal" viewBox="0 0 400 400"></svg>
</div>

<script>
const simbolos = {
  sun:"☉", moon:"☽", mercury:"☿", venus:"♀", mars:"♂",
  jupiter:"♃", saturn:"♄", uranus:"♅",
  neptune:"♆", pluto:"♇", chiron:"⚷", lilith:"⚸"
};

function gerarMapa() {
  const [year,month,day] = data.value.split("-");
  const [hour,minute] = hora.value.split(":");

  fetch("/api/mapa-natal", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      name:nome.value,
      year:+year, month:+month, day:+day,
      hour:+hour, minute:+minute,
      city:cidade.value,
      lat:+lat.value,
      lng:+lng.value,
      house_system:casas.value,
      include_features:[...extras.selectedOptions].map(o=>o.value)
    })
  })
  .then(r=>r.json())
  .then(desenharMapaNatal);
}

function desenharMapaNatal(dados){
  const svg = document.getElementById("mapaNatal");
  svg.innerHTML="";
  const cx=200, cy=200, r=170;

  desenharCirculo(r,"#a855f7",3);

  dados.houses.forEach(h=>desenharLinha(h.abs_pos));

  dados.planets.forEach(p=>desenharPlaneta(p));

  function desenharCirculo(raio,cor,esp){
    svg.appendChild(criar("circle",{cx,cy,r:raio,stroke:cor,"stroke-width":esp,fill:"none"}));
  }

  function desenharLinha(g){
    const a=(g-90)*Math.PI/180;
    svg.appendChild(criar("line",{
      x1:cx,y1:cy,
      x2:cx+r*Math.cos(a),
      y2:cy+r*Math.sin(a),
      stroke:"#334155"
    }));
  }

  function desenharPlaneta(p){
    const a=(p.abs_pos-90)*Math.PI/180;
    const x=cx+130*Math.cos(a);
    const y=cy+130*Math.sin(a);
    const t=criar("text",{x,y,fill:"#e5e7eb","text-anchor":"middle","font-size":"14"});
    t.textContent=simbolos[p.id]||p.name[0];
    svg.appendChild(t);
  }

  function criar(tag,attrs){
    const el=document.createElementNS("http://www.w3.org/2000/svg",tag);
    for(let k in attrs)el.setAttribute(k,attrs[k]);
    return el;
  }
}
</script>
</body>
</html>
